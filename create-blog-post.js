#!/usr/bin/env node

/**
 * Direct DeepSeek + Contentful Integration
 * Usage: node create-blog-post.js "Topic" "Author Name" "Category Name"
 */

const DEEPSEEK_API_KEY = 'sk-306eb3776ac04154b8d05a7c79ab2bbe';
const CONTENTFUL_SPACE_ID = 'rm7hib748uv7';
const CONTENTFUL_MANAGEMENT_TOKEN = 'CFPAT-yBPDay971BqnFXTN7U_RWNAJSdMMC0TxqYtNZZ_HWlk';

// Author and Category mappings
const AUTHORS = {
  'Sarah Johnson': '5gz83P25yjQSPFnVG5Dlgy',
  'Michael Chen': '5RQyPRZm3sQi8J7FYW1uVZ'
};

const CATEGORIES = {
  'Compliance': '21ROO2RRzFHhcmi1Cpl76l',
  'Whistleblowing': '32QpG3pEkmhtVnKB5xgEcM',
  'Industry Insights': '2CawJDdwt48P42VOTjcrn4'
};

async function generateBlogPost(topic) {
  console.log(`ü§ñ Generating blog post about: ${topic}`);
  
  const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${DEEPSEEK_API_KEY}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      model: 'deepseek-chat',
      messages: [
        {
          role: 'system',
          content: 'You are an expert content writer specializing in compliance, whistleblowing, and corporate governance. Create engaging, SEO-optimized blog posts.'
        },
        {
          role: 'user',
          content: `Create a comprehensive blog post about "${topic}" for a whistleblowing and compliance platform. 

Requirements:
- Title: Catchy and SEO-friendly (50-60 characters)
- Slug: URL-friendly version of title (lowercase, hyphens)
- Content: Well-structured with headings, paragraphs (800-1200 words)
- Excerpt: Compelling summary (150-200 characters)
- SEO Title: Optimized for search engines (30-60 characters)
- SEO Description: Meta description (120-160 characters)
- Tags: 3-5 relevant tags
- Reading Time: Estimate in minutes

Format the response as JSON with this exact structure:
{
  "title": "Your Title Here",
  "slug": "your-slug-here",
  "content": "Your full blog content with proper HTML formatting",
  "excerpt": "Your compelling excerpt here",
  "seoTitle": "SEO Optimized Title",
  "seoDescription": "SEO meta description here",
  "tags": ["tag1", "tag2", "tag3"],
  "readingTime": 5
}`
        }
      ],
      temperature: 0.7,
      max_tokens: 2000
    })
  });

  if (!response.ok) {
    throw new Error(`DeepSeek API error: ${response.statusText}`);
  }

  const data = await response.json();
  const generatedContent = data.choices[0]?.message?.content;

  if (!generatedContent) {
    throw new Error('No content generated by DeepSeek');
  }

  // Parse JSON from response
  const jsonMatch = generatedContent.match(/\{[\s\S]*\}/);
  if (!jsonMatch) {
    throw new Error('Invalid JSON response from DeepSeek');
  }

  return JSON.parse(jsonMatch[0]);
}

function convertHtmlToRichText(html) {
  // Convert HTML to Contentful Rich Text format
  // Parse HTML and convert to proper Rich Text structure
  
  const content = [];
  
  // Split by common HTML block elements
  const blocks = html.split(/(<\/?(?:h[1-6]|p|div|ul|ol|li|blockquote|br)\b[^>]*>)/i);
  
  let currentBlock = '';
  let inBlock = false;
  
  for (let i = 0; i < blocks.length; i++) {
    const block = blocks[i];
    
    // Check if this is an opening tag
    if (block.match(/^<(h[1-6]|p|div|ul|ol|li|blockquote)\b/i)) {
      inBlock = true;
      continue;
    }
    
    // Check if this is a closing tag
    if (block.match(/^<\/(h[1-6]|p|div|ul|ol|li|blockquote)>/i)) {
      if (currentBlock.trim()) {
        const tag = block.match(/^<\/(h[1-6]|p|div|ul|ol|li|blockquote)>/i)[1];
        
        if (tag.match(/^h[1-6]$/)) {
          // Heading
          const level = parseInt(tag[1]);
          content.push({
            nodeType: `heading-${level}`,
            data: {},
            content: [{
              nodeType: 'text',
              value: currentBlock.trim(),
              marks: [],
              data: {}
            }]
          });
        } else if (tag === 'p' || tag === 'div') {
          // Paragraph
          content.push({
            nodeType: 'paragraph',
            data: {},
            content: [{
              nodeType: 'text',
              value: currentBlock.trim(),
              marks: [],
              data: {}
            }]
          });
        } else if (tag === 'blockquote') {
          // Blockquote
          content.push({
            nodeType: 'blockquote',
            data: {},
            content: [{
              nodeType: 'paragraph',
              data: {},
              content: [{
                nodeType: 'text',
                value: currentBlock.trim(),
                marks: [],
                data: {}
              }]
            }]
          });
        }
      }
      currentBlock = '';
      inBlock = false;
      continue;
    }
    
    // Check for line breaks
    if (block === '<br>' || block === '<br/>') {
      if (currentBlock.trim()) {
        content.push({
          nodeType: 'paragraph',
          data: {},
          content: [{
            nodeType: 'text',
            value: currentBlock.trim(),
            marks: [],
            data: {}
          }]
        });
        currentBlock = '';
      }
      continue;
    }
    
    // If we're in a block, add the text content
    if (inBlock && !block.match(/^<[^>]*>$/)) {
      currentBlock += block;
    }
  }
  
  // Handle any remaining content
  if (currentBlock.trim()) {
    content.push({
      nodeType: 'paragraph',
      data: {},
      content: [{
        nodeType: 'text',
        value: currentBlock.trim(),
        marks: [],
        data: {}
      }]
    });
  }
  
  // If no content was parsed, fall back to simple paragraph
  if (content.length === 0) {
    const cleanText = html.replace(/<[^>]*>/g, '').trim();
    content.push({
      nodeType: 'paragraph',
      data: {},
      content: [{
        nodeType: 'text',
        value: cleanText,
        marks: [],
        data: {}
      }]
    });
  }
  
  return {
    nodeType: 'document',
    data: {},
    content: content
  };
}

async function createContentfulEntry(blogData, authorId, categoryId) {
  console.log('üìù Creating Contentful entry...');
  
  const entryData = {
    fields: {
      title: { 'en-US': blogData.title },
      slug: { 'en-US': blogData.slug },
      content: { 'en-US': convertHtmlToRichText(blogData.content) },
      excerpt: { 'en-US': blogData.excerpt },
      seoTitle: { 'en-US': blogData.seoTitle },
      seoDescription: { 'en-US': blogData.seoDescription },
      tags: { 'en-US': blogData.tags },
      readingTime: { 'en-US': blogData.readingTime },
      publishDate: { 'en-US': new Date().toISOString() },
      status: { 'en-US': 'draft' },
      author: { 'en-US': { sys: { id: authorId, linkType: 'Entry', type: 'Link' } } },
      categories: { 'en-US': [{ sys: { id: categoryId, linkType: 'Entry', type: 'Link' } }] }
    }
  };

  const response = await fetch(`https://api.contentful.com/spaces/${CONTENTFUL_SPACE_ID}/environments/master/entries`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${CONTENTFUL_MANAGEMENT_TOKEN}`,
      'Content-Type': 'application/vnd.contentful.management.v1+json',
      'X-Contentful-Content-Type': '9oYANGj5uBRT6UHsl5LxO'
    },
    body: JSON.stringify(entryData)
  });

  if (!response.ok) {
    const error = await response.text();
    throw new Error(`Contentful API error: ${response.statusText} - ${error}`);
  }

  const result = await response.json();
  console.log('‚úÖ Contentful entry created successfully!');
  console.log(`üìã Entry ID: ${result.sys.id}`);
  console.log(`üîó View in Contentful: https://app.contentful.com/spaces/${CONTENTFUL_SPACE_ID}/entries/${result.sys.id}`);
  
  return result;
}

async function main() {
  const args = process.argv.slice(2);
  
  if (args.length < 3) {
    console.log('Usage: node create-blog-post.js "Topic" "Author Name" "Category Name"');
    console.log('');
    console.log('Available Authors:');
    Object.keys(AUTHORS).forEach(name => console.log(`  - ${name}`));
    console.log('');
    console.log('Available Categories:');
    Object.keys(CATEGORIES).forEach(name => console.log(`  - ${name}`));
    console.log('');
    console.log('Example:');
    console.log('node create-blog-post.js "GDPR Compliance" "Sarah Johnson" "Compliance"');
    process.exit(1);
  }

  const [topic, authorName, categoryName] = args;
  
  const authorId = AUTHORS[authorName];
  const categoryId = CATEGORIES[categoryName];
  
  if (!authorId) {
    console.error(`‚ùå Author "${authorName}" not found. Available authors: ${Object.keys(AUTHORS).join(', ')}`);
    process.exit(1);
  }
  
  if (!categoryId) {
    console.error(`‚ùå Category "${categoryName}" not found. Available categories: ${Object.keys(CATEGORIES).join(', ')}`);
    process.exit(1);
  }

  try {
    // Step 1: Generate content with DeepSeek
    const blogData = await generateBlogPost(topic);
    
    console.log('‚úÖ Content generated successfully!');
    console.log(`üìù Title: ${blogData.title}`);
    console.log(`üîó Slug: ${blogData.slug}`);
    console.log(`‚è±Ô∏è Reading time: ${blogData.readingTime} minutes`);
    console.log(`üè∑Ô∏è Tags: ${blogData.tags.join(', ')}`);
    
    // Step 2: Create Contentful entry
    const entry = await createContentfulEntry(blogData, authorId, categoryId);
    
    console.log('');
    console.log('üéâ Blog post created successfully!');
    console.log('');
    console.log('Next steps:');
    console.log('1. Go to Contentful to review and edit the content');
    console.log('2. Add a featured image if needed');
    console.log('3. Publish the entry');
    console.log('4. The post will appear on your /blog page');
    
  } catch (error) {
    console.error('‚ùå Error:', error.message);
    process.exit(1);
  }
}

main();
