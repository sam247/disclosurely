#!/usr/bin/env node

/**
 * DeepSeek + Contentful Integration Script
 * Generates blog content using DeepSeek AI and creates Contentful entries
 */

import fetch from 'node-fetch';

interface DeepSeekResponse {
  choices: Array<{
    message: {
      content: string;
    };
  }>;
}

interface BlogPostData {
  title: string;
  slug: string;
  content: string;
  excerpt: string;
  seoTitle: string;
  seoDescription: string;
  tags: string[];
  readingTime: number;
}

class DeepSeekContentfulIntegration {
  private deepSeekApiKey: string;
  private baseUrl = 'https://api.deepseek.com/v1';

  constructor(deepSeekApiKey: string) {
    this.deepSeekApiKey = deepSeekApiKey;
  }

  /**
   * Generate blog post using DeepSeek AI
   */
  async generateBlogPost(topic: string): Promise<BlogPostData> {
    const prompt = this.createBlogPrompt(topic);
    
    try {
      const response = await fetch(`${this.baseUrl}/chat/completions`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${this.deepSeekApiKey}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          model: 'deepseek-chat',
          messages: [
            {
              role: 'system',
              content: 'You are an expert content writer specializing in compliance, whistleblowing, and corporate governance. Create engaging, SEO-optimized blog posts.'
            },
            {
              role: 'user',
              content: prompt
            }
          ],
          temperature: 0.7,
          max_tokens: 2000
        })
      });

      if (!response.ok) {
        throw new Error(`DeepSeek API error: ${response.statusText}`);
      }

      const data: DeepSeekResponse = await response.json();
      const generatedContent = data.choices[0]?.message?.content;

      if (!generatedContent) {
        throw new Error('No content generated by DeepSeek');
      }

      return this.parseGeneratedContent(generatedContent, topic);
    } catch (error) {
      console.error('Error generating blog post:', error);
      throw error;
    }
  }

  /**
   * Create comprehensive prompt for blog post generation
   */
  private createBlogPrompt(topic: string): string {
    return `Create a comprehensive blog post about "${topic}" for a whistleblowing and compliance platform.

Requirements:
- Title: Catchy and SEO-friendly (50-60 characters)
- Slug: URL-friendly version of title (lowercase, hyphens)
- Content: Well-structured with headings, paragraphs (800-1200 words)
- Excerpt: Compelling summary (150-200 characters)
- SEO Title: Optimized for search engines (30-60 characters)
- SEO Description: Meta description (120-160 characters)
- Tags: 3-5 relevant tags
- Reading Time: Estimate in minutes

Tone: Professional yet accessible, authoritative but not intimidating
Target Audience: Compliance professionals, whistleblowers, HR managers, legal teams

Format the response as JSON with this exact structure:
{
  "title": "Your Title Here",
  "slug": "your-slug-here",
  "content": "Your full blog content with proper HTML formatting",
  "excerpt": "Your compelling excerpt here",
  "seoTitle": "SEO Optimized Title",
  "seoDescription": "SEO meta description here",
  "tags": ["tag1", "tag2", "tag3"],
  "readingTime": 5
}`;
  }

  /**
   * Parse generated content into structured data
   */
  private parseGeneratedContent(content: string, topic: string): BlogPostData {
    try {
      const jsonMatch = content.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        const parsed = JSON.parse(jsonMatch[0]);
        return {
          title: parsed.title || `Complete Guide to ${topic}`,
          slug: parsed.slug || this.generateSlug(parsed.title || topic),
          content: parsed.content || content,
          excerpt: parsed.excerpt || this.generateExcerpt(content),
          seoTitle: parsed.seoTitle || parsed.title,
          seoDescription: parsed.seoDescription || parsed.excerpt,
          tags: parsed.tags || this.generateTags(topic),
          readingTime: parsed.readingTime || this.estimateReadingTime(content)
        };
      }
    } catch (error) {
      console.warn('Failed to parse JSON from DeepSeek response:', error);
    }

    return {
      title: `Complete Guide to ${topic}`,
      slug: this.generateSlug(topic),
      content: content,
      excerpt: this.generateExcerpt(content),
      seoTitle: `Complete Guide to ${topic}`,
      seoDescription: this.generateExcerpt(content),
      tags: this.generateTags(topic),
      readingTime: this.estimateReadingTime(content)
    };
  }

  private generateSlug(title: string): string {
    return title
      .toLowerCase()
      .replace(/[^a-z0-9\s-]/g, '')
      .replace(/\s+/g, '-')
      .replace(/-+/g, '-')
      .trim();
  }

  private generateExcerpt(content: string): string {
    const cleanContent = content.replace(/<[^>]*>/g, '');
    return cleanContent.substring(0, 200).trim() + '...';
  }

  private generateTags(topic: string): string[] {
    const baseTags = ['compliance', 'whistleblowing', 'corporate governance'];
    const topicTags = topic.toLowerCase().split(' ').slice(0, 2);
    return [...baseTags, ...topicTags].slice(0, 5);
  }

  private estimateReadingTime(content: string): number {
    const wordsPerMinute = 200;
    const wordCount = content.split(/\s+/).length;
    return Math.max(1, Math.ceil(wordCount / wordsPerMinute));
  }
}

/**
 * Main function to generate and create blog post
 */
async function generateAndCreateBlogPost(topic: string, authorId: string, categoryId: string) {
  const deepSeekApiKey = process.env.DEEPSEEK_API_KEY;
  
  if (!deepSeekApiKey) {
    console.error('DEEPSEEK_API_KEY environment variable is required');
    process.exit(1);
  }

  const integration = new DeepSeekContentfulIntegration(deepSeekApiKey);
  
  try {
    console.log(`ü§ñ Generating blog post about: ${topic}`);
    const blogData = await integration.generateBlogPost(topic);
    
    console.log('‚úÖ Content generated successfully!');
    console.log(`üìù Title: ${blogData.title}`);
    console.log(`üîó Slug: ${blogData.slug}`);
    console.log(`‚è±Ô∏è Reading time: ${blogData.readingTime} minutes`);
    console.log(`üè∑Ô∏è Tags: ${blogData.tags.join(', ')}`);
    
    // Here you would use Contentful MCP tools to create the entry
    // The blogData is ready to be passed to createContentfulBlogPost()
    
    console.log('\nüìã Ready to create Contentful entry with:');
    console.log(JSON.stringify(blogData, null, 2));
    
  } catch (error) {
    console.error('‚ùå Error:', error);
    process.exit(1);
  }
}

// CLI usage
if (require.main === module) {
  const args = process.argv.slice(2);
  if (args.length < 3) {
    console.log('Usage: node deepseek-contentful.js <topic> <authorId> <categoryId>');
    console.log('Example: node deepseek-contentful.js "GDPR Compliance" "5gz83P25yjQSPFnVG5Dlgy" "21ROO2RRzFHhcmi1Cpl76l"');
    process.exit(1);
  }
  
  const [topic, authorId, categoryId] = args;
  generateAndCreateBlogPost(topic, authorId, categoryId);
}

export { DeepSeekContentfulIntegration, generateAndCreateBlogPost };
